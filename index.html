<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>절대음감 퀴즈 v3.4 (Day1·2 단일 90/교란10, 점프토글, 통계)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin:16px; color:#111; }
  h1 { font-size:18px; margin:0 0 10px; }
  .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:8px 0; }
  button, select, input[type="range"] { font-size:15px; padding:9px 12px; }
  label { font-size:14px; color:#333; }
  #keys { display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-top:8px; }
  .key { padding:10px 8px; background:#f7f7f7; border:1px solid #ddd; border-radius:8px; font-size:14px; }
  #msg { margin-top:8px; font-weight:600; }
  #score, #rt, #audioState { margin-top:4px; color:#555; font-size:14px; }
  .badge { font-size:12px; padding:2px 6px; border-radius:6px; background:#eef; color:#224; }
  .sep { height:1px; background:#eee; margin:12px 0; }
  details { border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; }
  details+details { margin-top:8px; }
  summary { font-weight:600; cursor:pointer; }
  .section { margin-top:8px; }
  table { width:100%; border-collapse: collapse; margin-top:8px; }
  th, td { border:1px solid #ddd; padding:6px; font-size:12px; text-align:left; }
  th { background:#f3f5f8; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>
<h1>절대음감 퀴즈 v3.4</h1>

<div class="row">
  <label>주차:
    <select id="week">
      <option value="1">1주 (A, D)</option>
      <option value="2">2주 (A, D, C, F#)</option>
      <option value="3">3주 (+E, G#)</option>
      <option value="4">4주 (+B, F)</option>
      <option value="5">5주 (+C#, G)</option>
      <option value="6">6주 (12음 완성)</option>
      <option value="7">7주</option>
      <option value="8">8주</option>
      <option value="9">9주</option>
      <option value="10">10주</option>
      <option value="11">11주</option>
      <option value="12">12주</option>
    </select>
  </label>

  <label>요일:
    <select id="day">
      <option value="1">Day 1</option>
      <option value="2">Day 2</option>
      <option value="3">Day 3</option>
      <option value="4">Day 4</option>
      <option value="5">Day 5</option>
      <option value="6">Day 6</option>
      <option value="7">Day 7(평가)</option>
    </select>
  </label>

  <span id="dayTip" class="badge">오늘 포커스: 안정화</span>
</div>

<details open>
  <summary>세션</summary>
  <div class="section row">
    <button id="btnUnlock">오디오 활성화</button>
    <button id="btnTest">사운드 테스트</button>
    <label>볼륨 <input id="vol" type="range" min="0" max="100" value="30"></label>
  </div>

  <div class="section row">
    <button id="btnPrime">프라이밍(10회)</button>
    <button id="btnOne">한 문제</button>
    <button id="btnStart20">20문항 시작</button>
    <button id="btnStart20NF">무피드백 20문항</button>
    <button id="btnRepeat" disabled>방금 음 다시</button>
    <button id="btnReview" disabled>오답 3개 복습</button>
  </div>

  <div class="section row">
    <label>옥타브 범위
      <select id="oct">
        <option value="4">고정 4</option>
        <option value="3-5">랜덤 3–5</option>
        <option value="2-5">랜덤 2–5</option>
        <option value="2-6">랜덤 2–6</option>
      </select>
    </label>
    <label><input type="checkbox" id="jumpGuard" checked> 상대음감 차단(연속 1옥 이상 점프)</label>
    <button id="btnJumpGuardToggle">상대음감 차단: ON</button>
    <label><input type="checkbox" id="octNormalize" checked> 옥타브 음량 보정</label>
    <label>보정 강도
      <select id="normStrength">
        <option value="0.5">약</option>
        <option value="1" selected>보통</option>
        <option value="1.5">강</option>
      </select>
    </label>
  </div>

  <div class="section row">
    <label>음색
      <select id="timbre">
        <option value="default">기본</option>
        <option value="piano">피아노</option>
        <option value="violin">바이올린</option>
        <option value="cello">첼로</option>
        <option value="clarinet">클라리넷</option>
        <option value="flute">플룻</option>
        <option value="horn">호른</option>
        <option value="trumpet">트럼펫</option>
        <option value="bassoon">바순</option>
        <option value="trombone">트롬본</option>
        <option value="tuba">튜바</option>
        <option value="harp">하프</option>
        <option value="timpani">팀파니</option>
        <option value="strings">현악</option>
        <option value="woodwinds">목관</option>
        <option value="brass">금관</option>
      </select>
    </label>
    <label>프리뷰 옥타브
      <select id="previewOct">
        <option value="3">3옥</option>
        <option value="4" selected>4옥</option>
        <option value="5">5옥</option>
      </select>
    </label>
  </div>
</details>

<details>
  <summary>출제 옵션</summary>
  <div class="section row">
    <label><input type="checkbox" id="autoNewBoost" checked> 신규음 가중치(1~6주)</label>
    <label>강도
      <select id="boostLevel">
        <option value="1.5">×1.5</option>
        <option value="2" selected>×2</option>
        <option value="3">×3</option>
      </select>
    </label>
    <label><input type="checkbox" id="errorBoost"> 오답 음 가중치</label>
  </div>
  <div class="muted">Day 1·2는 단일 타깃 90% + 교란 10% 자동 적용(주차·오답 기록 기반). Day 7은 무피드백 평가 권장.</div>
</details>

<details open>
  <summary>키(정답/프리뷰)</summary>
  <div id="keys" class="row"></div>
  <div class="muted">대기 상태에선 키를 누르면 해당 음이 즉시 재생(프리뷰). 진행 중엔 정답 입력으로 동작합니다.</div>
</details>

<details open>
  <summary>진행 상황</summary>
  <div id="msg"></div>
  <div id="primeSeq"></div>
  <div id="score"></div>
  <div id="rt"></div>
  <div id="audioState"></div>
</details>

<details>
  <summary>통계/기록</summary>
  <div class="section row">
    <button id="btnShowStats">통계 보기/새로고침</button>
    <button id="btnExport">CSV 내보내기</button>
    <button id="btnClear">기록 초기화</button>
  </div>
  <div id="statsWrap" class="section"></div>
</details>

<div class="sep"></div>
<div class="muted">프라이밍은 10회: Day 1·2에서는 타깃음 비중을 높여 자동 생성됩니다. 퀴즈 중에는 정답 음명이 사전 노출되지 않습니다.</div>

<script>
/* ====== 기본 데이터 ====== */
const noteOrder = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const solfegeSharp = { "C":"do","C#":"di","D":"re","D#":"ri","E":"mi","F":"fa","F#":"fi","G":"sol","G#":"si","A":"la","A#":"li","B":"ti" };
const flatAlias   = { "C#":"Db","D#":"Eb","F#":"Gb","G#":"Ab","A#":"Bb" };
const flatSolf    = { "C#":"ra","D#":"me","F#":"se","G#":"le","A#":"te" };
const baseFreq4 = { "C":261.6256,"C#":277.1826,"D":293.6648,"D#":311.1270,"E":329.6276,"F":349.2282,"F#":369.9944,"G":391.9954,"G#":415.3047,"A":440.0000,"A#":466.1638,"B":493.8833 };
const weeks = {
  1:["A","D"],
  2:["A","D","C","F#"],
  3:["A","D","C","F#","E","G#"],
  4:["A","D","C","F#","E","G#","B","F"],
  5:["A","D","C","F#","E","G#","B","F","C#","G"],
  6:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  7:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  8:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  9:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  10:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  11:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"],
  12:["A","D","C","F#","E","G#","B","F","C#","G","D#","A#"]
};
const newByWeek = { 1:["A","D"], 2:["C","F#"], 3:["E","G#"], 4:["B","F"], 5:["C#","G"], 6:["D#","A#"] };
const dayFocus = { 1:"안정화(신규음 맛보기)", 2:"신규음 비중↑", 3:"스피드(첫 느낌 2초)", 4:"라이트 테스트", 5:"혼동쌍 정리", 6:"변형 시작", 7:"평가(무피드백)" };

/* ====== 오디오/체인 ====== */
let audioCtx=null, masterGain=null, unlocked=false;
function updateAudioState(){ document.getElementById("audioState").textContent = `오디오 상태: ${audioCtx? audioCtx.state : "uninitialized"}`; }
function ensureAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = document.getElementById("vol").value/100 * 0.8;
    masterGain.connect(audioCtx.destination);
  }
  if(audioCtx.state!=="running"){ audioCtx.resume().then(updateAudioState); } else updateAudioState();
}
function setMasterVolume(){
  if(!masterGain || !audioCtx) return;
  const v = document.getElementById("vol").value/100 * 0.8;
  masterGain.gain.setTargetAtTime(v, audioCtx.currentTime, 0.01);
}

/* 옥타브 보정 */
function octaveBaseComp(o){ const map={2:1.20,3:1.08,4:1.00,5:0.92,6:0.86}; return map[o] ?? 1.0; }
function octaveComp(o){ if(!document.getElementById("octNormalize").checked) return 1.0; const s=Number(document.getElementById("normStrength").value); return Math.pow(octaveBaseComp(o), s); }

/* 간단 음색 합성 */
function timbreSpec(){
  const t = document.getElementById("timbre").value;
  const base = { attack:0.01, release:0.08, filter:"lowpass", freq:12000, Q:0.7, drive:0.0 };
  const map = {
    default:{},
    piano:{ attack:0.005, release:0.20, filter:"lowpass", freq:6000, Q:0.9, drive:0.05 },
    violin:{ attack:0.03, release:0.25, filter:"lowpass", freq:8000, Q:1.0, drive:0.08 },
    cello:{ attack:0.02, release:0.25, filter:"lowpass", freq:5000, Q:1.0, drive:0.06 },
    clarinet:{ attack:0.01, release:0.15, filter:"bandpass", freq:2000, Q:1.2, drive:0.05 },
    flute:{ attack:0.02, release:0.12, filter:"highpass", freq:400, Q:0.7, drive:0.02 },
    horn:{ attack:0.02, release:0.20, filter:"lowpass", freq:4500, Q:1.1, drive:0.07 },
    trumpet:{ attack:0.005, release:0.15, filter:"bandpass", freq:2500, Q:1.3, drive:0.10 },
    bassoon:{ attack:0.02, release:0.20, filter:"bandpass", freq:900, Q:1.1, drive:0.06 },
    trombone:{ attack:0.01, release:0.22, filter:"bandpass", freq:1500, Q:1.1, drive:0.08 },
    tuba:{ attack:0.01, release:0.25, filter:"bandpass", freq:800, Q:1.0, drive:0.07 },
    harp:{ attack:0.003, release:0.30, filter:"lowpass", freq:7000, Q:0.9, drive:0.03 },
    timpani:{ attack:0.005, release:0.35, filter:"bandpass", freq:300, Q:1.4, drive:0.05 },
    strings:{ attack:0.02, release:0.22, filter:"lowpass", freq:7000, Q:1.0, drive:0.08 },
    woodwinds:{ attack:0.015, release:0.18, filter:"bandpass", freq:1800, Q:1.2, drive:0.05 },
    brass:{ attack:0.008, release:0.18, filter:"bandpass", freq:2200, Q:1.3, drive:0.09 }
  };
  return Object.assign({}, base, map[t]||{});
}

function freqFor(base, oct){ const f4=baseFreq4[base]; return f4 ? f4*Math.pow(2, oct-4) : null; }
function playNoteBase(base, oct, dur=1.0){
  ensureAudio();
  const ac=audioCtx, t0=ac.currentTime, spec=timbreSpec(), comp=octaveComp(oct);
  const osc = ac.createOscillator(); osc.type="sine"; osc.frequency.value = freqFor(base, oct);

  const shaper = ac.createWaveShaper();
  const curve = new Float32Array(256);
  const k = spec.drive*50;
  for(let i=0;i<256;i++){ const x = i/255*2-1; curve[i] = Math.tanh(k*x); }
  shaper.curve = curve; shaper.oversample = '2x';

  const biq = ac.createBiquadFilter(); biq.type = spec.filter; biq.frequency.value = spec.freq; biq.Q.value = spec.Q;

  const g = ac.createGain();
  const a=spec.attack, r=spec.release;
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(comp, t0+a);
  g.gain.setValueAtTime(comp, t0 + Math.max(a, dur-r));
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

  osc.connect(shaper).connect(biq).connect(g).connect(masterGain);
  osc.start(t0); osc.stop(t0 + dur + 0.03);
}

/* ====== 상태/유틸 ====== */
let currentNote=null, lastNote=null;
let in20=false, noFB=false, reviewQ=null;
let q=0, okCnt=0, wrongCounts={}, rts=[], qStart=null, timer=null;

function baseName(full){ return full.replace(/[0-9]/g,""); }
function getOct(full){ const m = full.match(/[0-9]/); return m? Number(m[0]) : 4; }
function choice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function msg(t, good=null){ const m=document.getElementById("msg"); m.textContent=t; m.style.color = good===true? "#0a8" : good===false? "#d33" : "#222"; }
function drawScore(){
  document.getElementById("score").textContent = in20? `진행: ${q}/20, 정답: ${okCnt}` : "";
  const rt=document.getElementById("rt");
  if(rts.length>0){ const avg=(rts.reduce((a,b)=>a+b,0)/rts.length)/1000; rt.textContent=`평균 반응시간: ${avg.toFixed(2)}초`; }
  else rt.textContent="";
}
function weekVal(){ return Number(document.getElementById("week").value); }
function dayVal(){ return Number(document.getElementById("day").value); }
function updateDayTip(){ const d=dayVal(); document.getElementById("dayTip").textContent = `오늘 포커스: ${dayFocus[d]||"안정화"}`; }

/* 옥타브 범위 */
function parseOctRange(){
  const v=document.getElementById("oct").value;
  if(v==="4") return [4,4];
  const [a,b]=v.split("-").map(Number);
  return [Math.min(a,b), Math.max(a,b)];
}
function pickOct(){ const [lo,hi]=parseOctRange(); return lo + Math.floor(Math.random()*(hi-lo+1)); }

/* 가중치(혼합일 때만 사용) */
function buildWeights(){
  const w=weekVal(), d=dayVal(), pool=weeks[w], weights={};
  if(w<=6 && document.getElementById("autoNewBoost").checked){
    const mult=Number(document.getElementById("boostLevel").value);
    (newByWeek[w]||[]).forEach(n=> weights[n]=(weights[n]||1)*mult);
    if(d===2) (newByWeek[w]||[]).forEach(n=> weights[n]=(weights[n]||1)*1.2);
  }
  if(document.getElementById("errorBoost").checked){
    const last = JSON.parse(localStorage.getItem("aeq_lastWrongCounts")||"{}");
    const pairs = Object.entries(last).sort((a,b)=>b[1]-a[1]).slice(0,2);
    pairs.forEach(([full,cnt])=>{
      const nb=baseName(full);
      if(weeks[w].includes(nb)) weights[nb]=(weights[nb]||1)+Math.min(2, Math.ceil(cnt/2));
    });
  }
  return weights;
}
function pickWeighted(list, weightMap){ const bag=[]; list.forEach(n=>{ const w=Math.max(1, weightMap[n]||1); for(let i=0;i<w;i++) bag.push(n); }); return choice(bag); }

/* 상대음감 차단: 연속 1옥 이상 점프 */
function semitoneIndex(nb, oc){ return noteOrder.indexOf(nb) + 12*oc; }
function pickWithJumpFrom(nbList){
  const force = document.getElementById("jumpGuard").checked;
  let tries=0;
  while(true){
    let nb = choice(nbList);
    let oc = pickOct();
    if(force && lastNote){
      const lastNB = baseName(lastNote), lastOC = getOct(lastNote);
      const diff = Math.abs(semitoneIndex(nb, oc) - semitoneIndex(lastNB, lastOC));
      if(diff < 12){
        if(document.getElementById("oct").value==="4"){
          oc = (Math.random()<0.5? 3:5);
          const diff2 = Math.abs(semitoneIndex(nb, oc) - semitoneIndex(lastNB, lastOC));
          if(diff2 >= 12) return nb+String(oc);
        }
        tries++; if(tries<50) continue;
      }
    }
    return nb+String(oc);
  }
}

/* Day 1·2 단일 타깃 선정 */
function getDayPrimary(){
  const w=weekVal(), d=dayVal();
  if(d!==1 && d!==2) return null;

  if(w<=6){
    const pair = newByWeek[w] || [];
    if(pair.length>=2){
      return d===1 ? pair[0] : pair[1];
    } else if(pair.length===1){
      return pair[0];
    } else {
      return weeks[w][0] || null;
    }
  } else {
    // 7~12주: 최근 오답 상위 2개
    const last = JSON.parse(localStorage.getItem("aeq_lastWrongCounts")||"{}");
    const pool = weeks[w];
    const top = Object.entries(last)
      .map(([full,c])=>({ nb: baseName(full), c }))
      .filter(x=> pool.includes(x.nb))
      .sort((a,b)=> b.c - a.c)
      .map(x=> x.nb);
    if(top.length>=2){
      return d===1 ? top[0] : top[1];
    } else if(top.length===1){
      return top[0];
    } else {
      // 아무 기록 없으면 풀에서 랜덤
      return choice(pool);
    }
  }
}

/* 출제: Day 1·2는 단일 90% + 교란 10% */
const SINGLE_RATIO = 0.9;
function nextQ(autoPlay=true){
  const w=weekVal(), d=dayVal(), pool=weeks[w];
  let nb;
  const primary = getDayPrimary();

  if((d===1 || d===2) && primary){
    if(Math.random() < SINGLE_RATIO){
      nb = primary;
    } else {
      const others = pool.filter(x=> x!==primary);
      nb = others.length? pickWeighted(others, buildWeights()) : primary;
    }
  } else {
    nb = pickWeighted(pool, buildWeights());
  }

  currentNote = pickWithJumpFrom([nb]); // 점프 차단 반영해 옥타브 선택
  msg("문제를 듣고 정답을 선택하세요.");
  document.getElementById("btnRepeat").disabled=false;
  if(autoPlay){ playNoteBase(baseName(currentNote), getOct(currentNote), 1.0); qStart = performance.now(); }
}

/* 세션 */
function start20(nf=false){
  in20=true; noFB=!!nf; q=0; okCnt=0; wrongCounts={}; rts=[]; drawScore();
  document.getElementById("btnReview").disabled=true;
  nextQ(true);
}
function answer(ansBase){
  if(!currentNote) return;
  const now=performance.now(); if(qStart) rts.push(now - qStart);
  const isOK = (ansBase===baseName(currentNote));
  if(!isOK) wrongCounts[currentNote]=(wrongCounts[currentNote]||0)+1;
  if(isOK) okCnt++; q++; drawScore();

  if(in20){
    if(!noFB) msg(isOK? `정답! (${currentNote})` : `오답… 정답은 ${currentNote}`, isOK); else msg(`응답 저장됨 (${q}/20)`);
    if(timer) clearTimeout(timer);
    lastNote = currentNote;
    if(q>=20){
      in20=false;
      localStorage.setItem("aeq_lastWrongCounts", JSON.stringify(wrongCounts));
      endSummary();
    } else {
      timer=setTimeout(()=> nextQ(true), 700);
    }
  } else if(reviewQ){
    msg(isOK? `정답! (${currentNote})` : `오답… 정답은 ${currentNote}`, isOK);
    if(reviewQ.length===0){ document.getElementById("btnReview").disabled=false; msg("복습 종료!"); reviewQ=null; }
    else { setTimeout(()=>{ currentNote=reviewQ.shift(); playNoteBase(baseName(currentNote), getOct(currentNote), 1.0); qStart=performance.now(); }, 650); }
  } else {
    msg(isOK? `정답! (${currentNote})` : `오답… 정답은 ${currentNote}`, isOK);
  }
}
function endSummary(){
  document.getElementById("btnRepeat").disabled=true;
  const keys = Object.keys(wrongCounts);
  const top3 = keys.sort((a,b)=> (wrongCounts[b]||0)-(wrongCounts[a]||0)).slice(0,3);
  const txt = top3.length ? ` | 오답 Top3: ${top3.join(", ")}` : "";
  msg(`세션 종료: 정답 ${okCnt}/20${txt}`); drawScore();
  document.getElementById("btnReview").disabled = top3.length===0;
  saveHistory({ date:today(), week:weekVal(), day:dayVal(), correct:okCnt, total:20, avgRT:avgRT(), top3, oct:document.getElementById("oct").value, timbre:document.getElementById("timbre").value });
  renderStats();
}

/* 복습 */
function startReview(){
  const keys = Object.keys(wrongCounts);
  const top3 = keys.sort((a,b)=> (wrongCounts[b]||0)-(wrongCounts[a]||0)).slice(0,3);
  if(top3.length===0){ msg("복습할 항목이 없습니다."); return; }
  const arr=[]; top3.forEach(n=>{ for(let i=0;i<3;i++) arr.push(n); });
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  reviewQ=arr; msg("오답 복습 시작(9문항)."); document.getElementById("btnReview").disabled=true;
  currentNote=reviewQ.shift(); playNoteBase(baseName(currentNote), getOct(currentNote), 1.0); qStart=performance.now();
}

/* 프라이밍(10회, Day1·2 타깃 비중↑) */
function doPriming(){
  const w=weekVal(), d=dayVal(), pool=weeks[w].slice();
  const primary = getDayPrimary();
  const seq=[]; const shown=[];
  msg("프라이밍 중…"); document.getElementById("primeSeq").textContent="";
  for(let i=0;i<10;i++){
    let nb;
    if((d===1||d===2) && primary){
      // 타깃 70% 비중
      nb = (Math.random()<0.7) ? primary : choice(pool.filter(x=>x!==primary));
    } else {
      nb = choice(pool);
    }
    const oc = pickOct();
    seq.push(nb+String(oc)); shown.push(`${nb}${oc}`);
  }
  let i=0;
  (function step(){
    if(i>=seq.length){ msg("프라이밍 완료"); return; }
    const nb=baseName(seq[i]), oc=getOct(seq[i]);
    document.getElementById("primeSeq").textContent = `프라이밍 진행: ${shown.slice(0,i+1).join(" → ")}`;
    playNoteBase(nb, oc, 1.0); i++; setTimeout(step, 1500);
  })();
}

/* 키(정답/프리뷰) */
function labelFor(n){
  if(flatAlias[n]) return `${n}(${flatAlias[n]}) · ${solfegeSharp[n]}(${flatSolf[n]})`;
  return `${n} · ${solfegeSharp[n]||""}`;
}
function onKeyPress(ansBase){
  if(in20 || reviewQ){ answer(ansBase); return; }
  const oc = Number(document.getElementById("previewOct").value);
  playNoteBase(ansBase, oc, 1.0);
}
function buildKeys(){
  const wrap=document.getElementById("keys"); wrap.innerHTML="";
  noteOrder.forEach(n=>{
    const b=document.createElement("button");
    b.className="key"; b.textContent=labelFor(n);
    b.addEventListener("click", ()=> onKeyPress(n));
    wrap.appendChild(b);
  });
}

/* 통계/기록 */
function today(){ const d=new Date(); const m=(d.getMonth()+1).toString().padStart(2,"0"); const day=d.getDate().toString().padStart(2,"0"); return `${d.getFullYear()}-${m}-${day}`; }
function avgRT(){ if(rts.length===0) return null; return +(rts.reduce((a,b)=>a+b,0)/rts.length/1000).toFixed(2); }
function loadHistory(){ return JSON.parse(localStorage.getItem("aeq_history")||"[]"); }
function saveHistory(rec){ const arr=loadHistory(); arr.push(rec); localStorage.setItem("aeq_history", JSON.stringify(arr)); }
function clearHistory(){ localStorage.removeItem("aeq_history"); }
function exportCSV(){
  const rows = [["date","week","day","correct","total","avgRT","top3","oct","timbre"]];
  loadHistory().forEach(r=> rows.push([r.date,r.week,r.day,r.correct,r.total,r.avgRT ?? "", (r.top3||[]).join(" "), r.oct, r.timbre]));
  const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=`earquiz_stats_${today()}.csv`; a.click(); URL.revokeObjectURL(url);
}
function renderStats(){
  const el=document.getElementById("statsWrap");
  const data=loadHistory();
  if(data.length===0){ el.innerHTML = '<div class="muted">아직 저장된 기록이 없습니다. 세션을 한 번 완료하면 자동 저장됩니다.</div>'; return; }
  const byDate = {}; data.forEach(r=>{ (byDate[r.date]=byDate[r.date]||[]).push(r); });
  const dates = Object.keys(byDate).sort(); const last7 = dates.slice(-7);
  function avg(arr, key){ const xs=arr.map(o=> o[key]).filter(v=> typeof v==="number"); if(xs.length===0) return null; return xs.reduce((a,b)=>a+b,0)/xs.length; }
  const lastRows = last7.map(d=>{ const arr=byDate[d]; const acc=avg(arr,"correct"); const rt=avg(arr,"avgRT"); return { d, acc: acc!=null? `${acc.toFixed(1)}/20`:"-", rt: rt!=null? `${rt.toFixed(2)}s`:"-" }; });
  const byWeek = {}; data.forEach(r=>{ (byWeek[r.week]=byWeek[r.week]||[]).push(r); });
  const weekRows = Object.keys(byWeek).sort((a,b)=>a-b).map(w=>{ const arr=byWeek[w]; const acc=avg(arr,"correct"); const rt=avg(arr,"avgRT"); return { w, acc: acc!=null? `${acc.toFixed(1)}/20`:"-", rt: rt!=null? `${rt.toFixed(2)}s`:"-" }; });
  el.innerHTML = `
    <h3>최근 7일</h3>
    <table>
      <thead><tr><th>날짜</th><th>평균 정답</th><th>평균 RT</th></tr></thead>
      <tbody>${lastRows.map(r=> `<tr><td>${r.d}</td><td>${r.acc}</td><td>${r.rt}</td></tr>`).join("")}</tbody>
    </table>
    <h3>주차별 평균</h3>
    <table>
      <thead><tr><th>주차</th><th>평균 정답</th><th>평균 RT</th></tr></thead>
      <tbody>${weekRows.map(r=> `<tr><td>${r.w}</td><td>${r.acc}</td><td>${r.rt}</td></tr>`).join("")}</tbody>
    </table>
  `;
}

/* 점프 차단 토글/단축키 */
function setJumpGuardState(on){
  const cb = document.getElementById("jumpGuard");
  const btn = document.getElementById("btnJumpGuardToggle");
  cb.checked = !!on;
  if(btn){ btn.textContent = `상대음감 차단: ${on ? "ON" : "OFF"}`; }
  localStorage.setItem("aeq_jumpGuard", on ? "1" : "0");
  msg(`상대음감 차단이 ${on ? "켜졌습니다" : "꺼졌습니다"}. (다음 문제부터 적용)`);
}
function initJumpGuardState(){
  const saved = localStorage.getItem("aeq_jumpGuard");
  const on = (saved===null) ? true : saved==="1";
  setJumpGuardState(on);
}

/* 초기화/이벤트 */
window.addEventListener("load", ()=>{
  document.getElementById("week").value="1";
  document.getElementById("day").value="1";
  document.getElementById("oct").value="4";
  updateDayTip(); buildKeys(); updateAudioState(); initJumpGuardState();

  document.getElementById("btnUnlock").addEventListener("click", ()=>{ ensureAudio(); unlocked=true; msg("오디오 활성화 완료!"); });
  document.body.addEventListener("pointerdown", ()=>{ if(!unlocked){ ensureAudio(); unlocked=true; } }, { once:true });
  document.getElementById("btnTest").addEventListener("click", ()=>{
    ensureAudio(); const oc=4; const seq=["A","C#","E","A"]; let i=0; msg("사운드 테스트 중…");
    (function step(){ if(i>=seq.length){ msg("테스트 완료. 시작해 보세요!"); return; } playNoteBase(seq[i], oc, 0.4); i++; setTimeout(step, 550); })();
  });
  document.getElementById("vol").addEventListener("input", ()=>{ ensureAudio(); setMasterVolume(); });
  document.getElementById("week").addEventListener("change", ()=> msg("주차 변경됨."));
  document.getElementById("day").addEventListener("change", updateDayTip);
  document.getElementById("oct").addEventListener("change", ()=> msg("옥타브 범위 변경됨."));
  document.getElementById("octNormalize").addEventListener("change", ()=> msg("옥타브 음량 보정 변경."));
  document.getElementById("normStrength").addEventListener("change", ()=> msg("보정 강도 변경."));
  document.getElementById("timbre").addEventListener("change", ()=> msg("음색 변경됨."));
  document.getElementById("autoNewBoost").addEventListener("change", ()=> msg("신규음 가중치 변경."));
  document.getElementById("boostLevel").addEventListener("change", ()=> msg("가중치 강도 변경."));
  document.getElementById("errorBoost").addEventListener("change", ()=> msg("오답 가중치 변경."));

  document.getElementById("btnPrime").addEventListener("click", doPriming);
  document.getElementById("btnOne").addEventListener("click", ()=>{ in20=false; noFB=false; q=0; okCnt=0; wrongCounts={}; rts=[]; drawScore(); document.getElementById("btnReview").disabled=true; document.getElementById("primeSeq").textContent=""; nextQ(true); });
  document.getElementById("btnStart20").addEventListener("click", ()=>{ document.getElementById("primeSeq").textContent=""; lastNote=null; start20(false); });
  document.getElementById("btnStart20NF").addEventListener("click", ()=>{ document.getElementById("primeSeq").textContent=""; lastNote=null; start20(true); });
  document.getElementById("btnRepeat").addEventListener("click", ()=>{ if(currentNote){ playNoteBase(baseName(currentNote), getOct(currentNote), 1.0); qStart=performance.now(); } });
  document.getElementById("btnReview").addEventListener("click", startReview);

  document.getElementById("btnShowStats").addEventListener("click", renderStats);
  document.getElementById("btnExport").addEventListener("click", exportCSV);
  document.getElementById("btnClear").addEventListener("click", ()=>{ if(confirm("모든 기록을 삭제할까요?")){ clearHistory(); renderStats(); } });

  document.getElementById("btnJumpGuardToggle").addEventListener("click", ()=>{
    const now = document.getElementById("jumpGuard").checked;
    setJumpGuardState(!now);
  });
  window.addEventListener("keydown", (ev)=>{
    if(ev.key.toLowerCase()==="j"){
      const now = document.getElementById("jumpGuard").checked;
      setJumpGuardState(!now);
    }
  });
});
</script>
</body>
</html>